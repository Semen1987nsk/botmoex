# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ MOEX Breakout Bot

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

Telegram-–±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ **–ø—Ä–æ–±–æ–µ–≤ –∫–∞–Ω–∞–ª–æ–≤ –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏** –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –ë–∏—Ä–∂–∏ (–∞–∫—Ü–∏–∏, —Ñ—å—é—á–µ—Ä—Å—ã). –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—ã—Ö–æ–¥ —Ü–µ–Ω—ã –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
botmoex/
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ bot.py              # Telegram-–±–æ—Ç (aiogram 3.0)
‚îÇ   ‚îú‚îÄ‚îÄ moex_client.py      # –ö–ª–∏–µ–Ω—Ç MOEX ISS API
‚îÇ   ‚îú‚îÄ‚îÄ tinkoff_client.py   # –ö–ª–∏–µ–Ω—Ç Tinkoff Invest API
‚îÇ   ‚îî‚îÄ‚îÄ analyzer.py         # –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: —Ä–∞—Å—á—ë—Ç –∫–∞–Ω–∞–ª–æ–≤ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
‚îú‚îÄ‚îÄ check_aflt.py           # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª—é–±–æ–≥–æ —Ç–∏–∫–µ—Ä–∞
‚îú‚îÄ‚îÄ requirements.txt        # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ .env                    # –¢–æ–∫–µ–Ω—ã (–Ω–µ –≤ Git!)
```

### –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–•                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      MOEX ISS API          ‚îÇ       Tinkoff Invest API           ‚îÇ
‚îÇ  (–∏—Å—Ç–æ—Ä–∏—è –¥–æ –≤—á–µ—Ä–∞)        ‚îÇ    (—Å–µ–≥–æ–¥–Ω—è + real-time —Ü–µ–Ω—ã)      ‚îÇ
‚îÇ  ‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ               ‚îÇ    ‚Ä¢ –¢—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω                 ‚îÇ
‚îÇ  ‚Ä¢ –ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤             ‚îÇ    ‚Ä¢ –õ–∏–º–∏—Ç 200 req/min             ‚îÇ
‚îÇ  ‚Ä¢ –ó–∞–¥–µ—Ä–∂–∫–∞ 15 –º–∏–Ω         ‚îÇ    ‚Ä¢ Real-time –¥–∞–Ω–Ω—ã–µ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                               ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ     –ì–ò–ë–†–ò–î–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê       ‚îÇ
              ‚îÇ  MOEX (–∏—Å—Ç–æ—Ä–∏—è) + Tinkoff    ‚îÇ
              ‚îÇ      (—Å–µ–≥–æ–¥–Ω—è)               ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ       ANALYZER.PY            ‚îÇ
              ‚îÇ  –†–∞—Å—á—ë—Ç –∫–∞–Ω–∞–ª–∞ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏     ‚îÇ
              ‚îÇ  (300 —Å–≤–µ—á–µ–π √ó 3.5œÉ)         ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ         BOT.PY               ‚îÇ
              ‚îÇ  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + Telegram       ‚îÇ
              ‚îÇ  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                 ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –ö–∞–Ω–∞–ª –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞

```python
# 1. –õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è (–º–µ—Ç–æ–¥ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤)
# y = mx + c, –≥–¥–µ:
#   m - –Ω–∞–∫–ª–æ–Ω (slope)
#   c - —Å–º–µ—â–µ–Ω–∏–µ (intercept)

x = np.arange(300)  # [0, 1, 2, ..., 299]
y = closes[-300:]   # –ø–æ—Å–ª–µ–¥–Ω–∏–µ 300 —Ü–µ–Ω –∑–∞–∫—Ä—ã—Ç–∏—è

A = np.vstack([x, np.ones(300)]).T
m, c = np.linalg.lstsq(A, y, rcond=None)[0]

# 2. –ó–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ
regression = m * 299 + c

# 3. –û—Å—Ç–∞—Ç–∫–∏ (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –ª–∏–Ω–∏–∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏)
predicted = m * x + c
residuals = y - predicted

# 4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (POPULATION, ddof=0)
# ‚ö†Ô∏è –í–ê–ñ–ù–û: ddof=0 –∫–∞–∫ –≤ TradingView/Finam!
std = np.std(residuals, ddof=0)

# 5. –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞–Ω–∞–ª–∞
upper = regression + std * 3.5
lower = regression - std * 3.5
```

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: ddof=0 vs ddof=1

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –§–æ—Ä–º—É–ª–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|----------|---------|---------------|
| `ddof=0` (population) | œÉ = ‚àö(Œ£(x-Œº)¬≤/n) | **TradingView, Finam, –Ω–∞—à –±–æ—Ç** |
| `ddof=1` (sample) | s = ‚àö(Œ£(x-Œº)¬≤/(n-1)) | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–∞—É—á–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã |

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ddof=1`, –∫–∞–Ω–∞–ª—ã –±—É–¥—É—Ç —à–∏—Ä–µ –∏ –Ω–µ —Å–æ–≤–ø–∞–¥—É—Ç —Å Finam!**

### Realtime –ø–µ—Ä–µ—Å—á—ë—Ç

–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ —Å–≤–µ—á–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è realtime –ø–µ—Ä–µ—Å—á—ë—Ç:

```python
def calculate_linreg_realtime(closes_299, current_price, std_dev_mult=3.5):
    """
    –ë–µ—Ä—ë–º 299 –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–≤–µ—á–µ–π + —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É = 300 —Ç–æ—á–µ–∫.
    –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–≥—Ä–µ—Å—Å–∏—é –ø–æ–ª–Ω–æ—Å—Ç—å—é.
    """
    y = np.append(closes_299, current_price)
    # ... –¥–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç
```

---

## üîå API: –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### MOEX ISS API

**–ë–∞–∑–æ–≤—ã–π URL:** `https://iss.moex.com/iss`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ endpoint'–æ–≤:**
```
/engines/{engine}/markets/{market}/boards/{board}/securities/{symbol}/candles.json
```

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | Engine | Market | Board |
|------------|--------|--------|-------|
| –ê–∫—Ü–∏–∏ | `stock` | `shares` | `TQBR` |
| –§—å—é—á–µ—Ä—Å—ã | `futures` | `forts` | `RFUD` |
| –û–±–ª–∏–≥–∞—Ü–∏–∏ | `stock` | `bonds` | `TQOB` |

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å–≤–µ—á–µ–π:**
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ò–Ω—Ç–µ—Ä–≤–∞–ª |
|----------|----------|
| `1` | 1 –º–∏–Ω—É—Ç–∞ |
| `10` | 10 –º–∏–Ω—É—Ç |
| `60` | 1 —á–∞—Å |
| `24` | 1 –¥–µ–Ω—å |

**‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º—É–º **500 —Å–≤–µ—á–µ–π** –∑–∞ –∑–∞–ø—Ä–æ—Å ‚Üí –Ω—É–∂–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è
- –î–∞–Ω–Ω—ã–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ~15 –º–∏–Ω—É—Ç
- –ù–µ—Ç real-time

**–ü–∞–≥–∏–Ω–∞—Ü–∏—è:**
```python
params = {
    'interval': 10,
    'from': '2026-01-01',
    'start': 0  # offset: 0, 500, 1000...
}
```

### Tinkoff Invest API

**–ü—Ä–æ—Ç–æ–∫–æ–ª:** gRPC (Python SDK: `tinkoff-investments`)

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –¢–æ–∫–µ–Ω –∏–∑ https://www.tinkoff.ru/invest/settings/api/

**‚ö†Ô∏è –õ–∏–º–∏—Ç—ã:**
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –õ–∏–º–∏—Ç |
|-----------|-------|
| –û–±—â–∏–π | 200 req/min |
| GetCandles | 300 req/min |
| GetLastPrices | 100 req/min |

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞:**
```python
except Exception as e:
    if 'RESOURCE_EXHAUSTED' in str(e):
        await asyncio.sleep(5)  # –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
```

**–¢–∏–ø—ã —Å–≤–µ—á–µ–π (CandleSource):**
- `CANDLE_SOURCE_EXCHANGE` ‚Äî –±–∏—Ä–∂–µ–≤—ã–µ —Å–≤–µ—á–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º!)
- `CANDLE_SOURCE_DEALER_WEEKEND` ‚Äî —Å–≤–µ—á–∏ –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞ (–≤—ã—Ö–æ–¥–Ω—ã–µ)

**–§–æ—Ä–º–∞—Ç —Ü–µ–Ω—ã (Quotation):**
```python
price = quotation.units + quotation.nano / 1e9
# –ü—Ä–∏–º–µ—Ä: units=265, nano=500000000 ‚Üí 265.5
```

---

## üîÑ –ì–∏–±—Ä–∏–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—á–µ–º—É –≥–∏–±—Ä–∏–¥–Ω–∞—è?

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|----------|-------|--------|
| **–¢–æ–ª—å–∫–æ Tinkoff** | Real-time | –õ–∏–º–∏—Ç—ã API, –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **–¢–æ–ª—å–∫–æ MOEX** | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ | –ù–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö |
| **–ì–∏–±—Ä–∏–¥** | ‚úÖ –õ—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –º–∏—Ä–æ–≤ | –°–ª–æ–∂–Ω–µ–µ –ª–æ–≥–∏–∫–∞ |

### –ê–ª–≥–æ—Ä–∏—Ç–º

```python
# 1. MOEX: –∏—Å—Ç–æ—Ä–∏—è –¥–æ –≤—á–µ—Ä–∞ (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)
df_moex = await moex.get_candles_until_today(
    engine, market, board, ticker, 
    interval=10, days_back=15
)

# 2. Tinkoff: —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è (—ç–∫–æ–Ω–æ–º–∏–º –ª–∏–º–∏—Ç—ã)
df_today = await tinkoff.get_candles_today_only(figi, interval_mins=10)

# 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º
df = pd.concat([df_moex, df_today])
df = df.drop_duplicates(subset=['begin']).sort_values('begin')
```

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏

- **MOEX** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –≤ –ú–°–ö (–±–µ–∑ timezone)
- **Tinkoff** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –≤ UTC

–í `tinkoff_client.py` –º—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º UTC ‚Üí –ú–°–ö:
```python
msk_time = candle.time + datetime.timedelta(hours=3)
msk_time = msk_time.replace(tzinfo=None)  # —É–±–∏—Ä–∞–µ–º timezone –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```

---

## ü§ñ –õ–æ–≥–∏–∫–∞ Telegram-–±–æ—Ç–∞

### –ö–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/start` | –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `/scan` | –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ |
| `/stop` | –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ |
| `/status` | –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ |
| `/check` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å OZON, GAZP, SFIN |
| `/ticker SBER` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª—é–±–æ–π —Ç–∏–∫–µ—Ä |

### –¶–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```python
async def monitoring_loop():
    while monitoring:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ (7:00-24:00 –ú–°–ö)
        if not is_trading_time():
            await asyncio.sleep(60)
            continue
        
        # 2. –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç: –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞–Ω–∞–ª—ã
        if new_candle_closed():
            await update_all_channels()
            await send_periodic_summary()
        
        # 3. –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–Ω—ã
        await check_prices_batch()
        
        await asyncio.sleep(1)
```

### –õ–æ–≥–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤

```python
# –û–¥–∏–Ω —Å–∏–≥–Ω–∞–ª –∑–∞ —Å–≤–µ—á—É (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)
if last_signal_candle == current_candle:
    return  # —É–∂–µ –±—ã–ª —Å–∏–≥–Ω–∞–ª

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–æ—è
if price > upper and last_signal_type != 'up':
    send_signal('up')
    last_signal_type = 'up'
    last_signal_candle = current_candle

elif price < lower and last_signal_type != 'down':
    send_signal('down')
    last_signal_type = 'down'
    last_signal_candle = current_candle

# –°–±—Ä–æ—Å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –∫–∞–Ω–∞–ª
elif lower <= price <= upper:
    last_signal_type = None  # –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –Ω–æ–≤–æ–º—É —Å–∏–≥–Ω–∞–ª—É
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –§–∞–π–ª `.env`

```bash
BOT_TOKEN=123456:ABC...      # Telegram Bot Token
TINKOFF_TOKEN=t.xxx...       # Tinkoff Invest API Token
CHAT_ID=123456789            # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### –§–∞–π–ª `app/config.py`

```python
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
TIMEFRAME = 10           # –¢–∞–π–º—Ñ—Ä–µ–π–º —Å–≤–µ—á–µ–π (–º–∏–Ω—É—Ç—ã)
REGRESSION_LENGTH = 300  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
STD_DEV_MULTIPLIER = 3.5 # –ú–Ω–æ–∂–∏—Ç–µ–ª—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

# –¢–æ—Ä–≥–æ–≤–∞—è —Å–µ—Å—Å–∏—è MOEX (–ú–°–ö)
TRADING_START_HOUR = 7   # 06:50 –ú–°–ö
TRADING_END_HOUR = 24    # 23:50 –ú–°–ö
```

---

## ‚ö†Ô∏è –ü—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

### 1. –õ–∏–º–∏—Ç—ã Tinkoff API

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ 300+ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ª–µ–≥–∫–æ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `get_last_prices_batch()` ‚Äî –¥–æ 100 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∑–∞ –∑–∞–ø—Ä–æ—Å
- –ì–∏–±—Ä–∏–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: MOEX –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, Tinkoff —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è
- Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ `RESOURCE_EXHAUSTED`

### 2. –ü–∞–≥–∏–Ω–∞—Ü–∏—è MOEX

**–ü—Ä–æ–±–ª–µ–º–∞:** MOEX –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 500 —Å–≤–µ—á–µ–π.

**–†–µ—à–µ–Ω–∏–µ:**
```python
while True:
    data = await get_candles(start=offset)
    if len(data) < 500:
        break
    offset += 500
```

### 3. –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ MOEX vs Tinkoff

**–ü—Ä–æ–±–ª–µ–º–∞:** MOEX –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ú–°–ö, Tinkoff ‚Äî UTC.

**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Tinkoff UTC ‚Üí –ú–°–ö –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º.

### 4. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏–π/—Ñ—å—é—á–µ—Ä—Å–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 300 —Å–≤–µ—á–µ–π.

**–†–µ—à–µ–Ω–∏–µ:**
```python
if len(df) < REGRESSION_LENGTH:
    logger.warning(f"{ticker}: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö")
    return
```

### 5. –§—å—é—á–µ—Ä—Å—ã: —ç–∫—Å–ø–∏—Ä–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—å—é—á–µ—Ä—Å—ã –∏–º–µ—é—Ç –¥–∞—Ç—É —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ (SiH6 ‚Üí –º–∞—Ä—Ç 2026).

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
nearest = min(contracts, key=lambda x: x['expiration'])
```

### 6. –í—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∏—Ä–∂–∞ –∑–∞–∫—Ä—ã—Ç–∞, –Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
```python
if not is_trading_time():
    await asyncio.sleep(60)  # —Ä–µ–¥–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
```

### 7. –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ MOEX + Tinkoff –º–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã.

**–†–µ—à–µ–Ω–∏–µ:**
```python
df = df.drop_duplicates(subset=['begin'], keep='last')
```

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç–∏–∫–µ—Ä–∞

```bash
# –ê–∫—Ü–∏—è
python check_aflt.py SBER

# –§—å—é—á–µ—Ä—Å
python check_aflt.py SiH6 future
```

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python main.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫

```bash
python -c "from app.bot import *; print('OK')"
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Finam/TradingView

–ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **–º–µ–Ω–µ–µ 0.1%**:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Finam | –ù–∞—à —Ä–∞—Å—á—ë—Ç | –†–∞–∑–Ω–∏—Ü–∞ |
|----------|-------|------------|---------|
| Upper | 57.95 | 57.91 | -0.04 (0.07%) |
| Mid | 56.72 | 56.70 | -0.02 (0.04%) |
| Lower | 55.48 | 55.49 | +0.01 (0.02%) |

**–ü—Ä–∏—á–∏–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π:**
1. –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–∫—É–Ω–¥—ã/–º–∏–Ω—É—Ç—ã)
2. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
3. –†–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ü–µ–Ω

---

## üöÄ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- [ ] WebSocket/Streaming –≤–º–µ—Å—Ç–æ polling –¥–ª—è real-time —Ü–µ–Ω
- [ ] Redis/SQLite –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–µ—á–µ–π
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å–∏–≥–Ω–∞–ª–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- [ ] –§–∏–ª—å—Ç—Ä—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±–æ—Ä–æ—Ç)
- [ ] –ù–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] Backtesting –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [ ] Finam API –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- [ ] Alor/–ë–ö–° API
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–æ—Ä–≥–æ–≤—ã–º–∏ —Ä–æ–±–æ—Ç–∞–º–∏

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `.env` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `config.py` —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `requirements.txt` –∞–∫—Ç—É–∞–ª–µ–Ω
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–∫–µ—Ä–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —Ç–æ—Ä–≥–æ–≤—É—é —Å–µ—Å—Å–∏—é
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ (systemd/docker)

---

## üÜò –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### "RESOURCE_EXHAUSTED"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç Tinkoff API.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–∂–¥–∞—Ç—å 1-5 –º–∏–Ω—É—Ç –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤.

### "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—á–µ–π"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π.

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å `days_back` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.

### "FIGI –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∏–∫–µ—Ä –Ω–µ —Ç–æ—Ä–≥—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Tinkoff.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–∫–µ—Ä –Ω–∞ —Å–∞–π—Ç–µ Tinkoff Investments.

### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å Finam > 1%

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `ddof` –∏–ª–∏ —Ä–∞–∑–Ω—ã–π –Ω–∞–±–æ—Ä —Å–≤–µ—á–µ–π.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `ddof=0` –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 300).

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ —è–Ω–≤–∞—Ä—å 2026. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å!*
